- name: Disable root login
  shell: passwd -l root
  become: true

- name: Blacklist pcspkr from being loaded by kernel (beep)
  become: true
  copy:
    content: blacklist pcspkr
    dest: /etc/modprobe.d/nobeep.conf

- name: Set as default locale
  become: true
  command: localectl set-locale LANG=en_US.UTF-8

- name: Configure time server
  block:
    - name: Stop systemd-timesyncd
      become: true
      service:
        name: systemd-timesyncd
        enabled: false
    - name: Install chrony
      become: true
      pacman:
        name: chrony
        state: present
    - name: Start and enable chronyd
      become: true
      service:
        name: chronyd
        enabled: true

- name: Configure mirror updating
  block:
    - name: Install reflector
      become: true
      pacman:
        name: reflector
        state: present
    - name: Create service configuration
      copy:
        dest: "/etc/systemd/system/reflector.service"
        content: |
          [Unit]
          Description=Pacman mirrorlist update
          Wants=network-online.target
          After=network-online.target

          [Service]
          Type=oneshot
          ExecStart=/usr/bin/reflector --protocol https --latest 30 --number 20 --sort rate --save /etc/pacman.d/mirrorlist

          [Install]
          RequiredBy=multi-user.target
      become: true
    - name: Start and enable relector service
      service:
        name: reflector
        enabled: true
      become: true

- name: Install yay
  block:
    - tempfile:
        state: directory
      register: temp
    - shell: |
        git clone https://aur.archlinux.org/yay.git
        cd yay
        makepkg -si --noconfirm
      args:
        chdir: "{{ temp.path }}"
        creates: /usr/bin/yay
    
- name: Install man
  become: true
  pacman:
    name: man-db
    state: present

- name: Install tree
  become: true
  pacman:
    name: tree
    state: present

- name: Login Manager
  block:
    - name: Install ly
      shell: yay --needed --noconfirm -S ly
      args:
        creates: /sbin/ly
    - name: Enable ly service
      become: true
      service:
        name: ly
        enabled: true

- name: Bluetooth
  block:
    - name: Install bluez
      become: true
      pacman:
        name:
          - bluez
          - bluez-utils
        state: present
    - name: Copy Bluetooth configuration 
      become: true
      copy:
        content: |
          [Policy]
          AutoEnable=true
        dest: /etc/bluetooth/main.conf
    - name: Start and enable bluetooth service
      become: true
      service:
        name: bluetooth
        enabled: true

- name: Audio
  block:
    - name: Install pipewire
      become: true
      pacman:
        name:
          - wireplumber
          - pipewire
          - pipewire-alsa
          - pipewire-pulse
          - pipewire-jack
          - helvum
          - pamixer
          - playerctl
          - pavucontrol
          - mpd
          - sof-firmware
        state: present
    - name: Start and enable mpd service
      become: true
      service:
        name: mpd
        enabled: true


